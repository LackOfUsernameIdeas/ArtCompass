import { FC, Fragment, useEffect, useState } from "react";
import { DataType } from "./individualStats-types";
import { checkTokenValidity, fetchData } from "./helper_functions";
import { useNavigate } from "react-router-dom";
import FadeInWrapper from "../../components/common/loader/fadeinwrapper";
import { showNotification } from "../recommendations/helper_functions";
import Notification from "../../components/common/notification/Notification";
import { NotificationState } from "../recommendations/recommendations-types";
import ActorsDirectorsWritersRecommendationsTable from "./Components/ActorsDirectorsWritersRecommendationsTable";
import MoviesAndSeriesRecommendationsTable from "./Components/MoviesAndSeriesRecommendationsTable";
import GenresBarChart from "./Components/GenresBarChart";
import CountWidgets from "./Components/CountWidgets";

interface IndividualStatsProps {}

const IndividualStats: FC<IndividualStatsProps> = () => {
  // –°—ä—Å—Ç–æ—è–Ω–∏—è –∑–∞ –∑–∞–¥—ä—Ä–∂–∞–Ω–µ –Ω–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏ –¥–∞–Ω–Ω–∏
  const [data, setData] = useState<DataType>({
    topRecommendations: {
      recommendationsCount: {
        movies: 0,
        series: 0
      },
      recommendations: []
    }, // –¢–æ–ø –ø—Ä–µ–ø–æ—Ä—ä–∫–∏
    topGenres: [], // –¢–æ–ø –∂–∞–Ω—Ä–æ–≤–µ
    sortedDirectorsByRecommendationCount: [], // –†–µ–∂–∏—Å—å–æ—Ä–∏, —Å–æ—Ä—Ç–∏—Ä–∞–Ω–∏ –ø–æ –ø—Ä–æ—Ü—ä—Ñ—Ç—è–≤–∞–Ω–µ
    sortedActorsByRecommendationCount: [], // –ê–∫—Ç—å–æ—Ä–∏, —Å–æ—Ä—Ç–∏—Ä–∞–Ω–∏ –ø–æ –ø—Ä–æ—Ü—ä—Ñ—Ç—è–≤–∞–Ω–µ
    sortedWritersByRecommendationCount: [] // –°—Ü–µ–Ω–∞—Ä–∏—Å—Ç–∏, —Å–æ—Ä—Ç–∏—Ä–∞–Ω–∏ –ø–æ –ø—Ä–æ—Ü—ä—Ñ—Ç—è–≤–∞–Ω–µ
  });

  const [notification, setNotification] = useState<NotificationState | null>(
    null
  ); // –°—ä—Å—Ç–æ—è–Ω–∏–µ –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏–∑–≤–µ—Å—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä —Å—ä–æ–±—â–µ–Ω–∏—è –∑–∞ –≥—Ä–µ—à–∫–∏, —É—Å–ø–µ—Ö–∏ –∏–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è)
  const [loading, setLoading] = useState<boolean>(true);
  const navigate = useNavigate();

  const handleNotificationClose = () => {
    // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –∏–∑–≤–µ—Å—Ç–∏—è—Ç–∞
    if (notification?.type === "error") {
      // –ê–∫–æ –∏–∑–≤–µ—Å—Ç–∏–µ—Ç–æ –µ –æ—Ç —Ç–∏–ø "–≥—Ä–µ—à–∫–∞", –ø—Ä–µ–Ω–∞—Å–æ—á–≤–∞–Ω–µ –∫—ä–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ –∑–∞ –≤—Ö–æ–¥
      navigate("/signin");
    }
    setNotification(null); // –ó–∞–Ω—É–ª—è–≤–∞–Ω–µ –Ω–∞ –∏–∑–≤–µ—Å—Ç–∏–µ—Ç–æ
  };

  useEffect(() => {
    const validateToken = async () => {
      // –§—É–Ω–∫—Ü–∏—è –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏—è —Ç–æ–∫–µ–Ω
      const redirectUrl = await checkTokenValidity(); // –ò–∑–≤–∏–∫–≤–∞–Ω–µ –Ω–∞ –ø–æ–º–æ—â–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ –≤–∞–ª–∏–¥–∏—Ä–∞–Ω–µ –Ω–∞ —Ç–æ–∫–µ–Ω–∞
      if (redirectUrl) {
        // –ê–∫–æ —Ç–æ–∫–µ–Ω—ä—Ç –µ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –∏–∑–≤–µ—Å—Ç–∏–µ
        showNotification(
          setNotification, // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∑–∞–¥–∞–≤–∞–Ω–µ –Ω–∞ –∏–∑–≤–µ—Å—Ç–∏–µ
          "–í–∞—à–∞—Ç–∞ —Å–µ—Å–∏—è –µ –∏–∑—Ç–µ–∫–ª–∞. –ú–æ–ª—è, –≤–ª–µ–∑—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ –í–∏ –æ—Ç–Ω–æ–≤–æ.", // –°—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –∏–∑–≤–µ—Å—Ç–∏–µ—Ç–æ
          "error" // –¢–∏–ø—ä—Ç –Ω–∞ –∏–∑–≤–µ—Å—Ç–∏–µ—Ç–æ (–≥—Ä–µ—à–∫–∞)
        );
      }
    };

    validateToken(); // –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞ –Ω–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –ø—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

    const token =
      localStorage.getItem("authToken") || sessionStorage.getItem("authToken"); // –í–∑–µ–º–∞–Ω–µ –Ω–∞ —Ç–æ–∫–µ–Ω –æ—Ç localStorage –∏–ª–∏ sessionStorage

    if (token) {
      setLoading(true);
      fetchData(token, setData, setLoading); // –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ —Å –ø–æ–º–æ—â—Ç–∞ –Ω–∞ fetchData —Ñ—É–Ω–∫—Ü–∏—è—Ç–∞
      console.log("fetching"); // –õ–æ–≥ –∑–∞ —Å–ª–µ–¥–µ–Ω–µ –Ω–∞ –∏–∑–≤–ª–∏—á–∞–Ω–µ—Ç–æ –Ω–∞ –¥–∞–Ω–Ω–∏
    }
  }, []);

  if (loading) {
    return (
      <FadeInWrapper loadingTimeout={30000}>
        <div></div>
      </FadeInWrapper>
    );
  }

  if (
    !data.topRecommendations.recommendations ||
    data.topRecommendations.recommendations.length === 0 ||
    !data.topGenres.length ||
    !data.sortedDirectorsByRecommendationCount.length ||
    !data.sortedActorsByRecommendationCount.length ||
    !data.sortedWritersByRecommendationCount.length
  ) {
    return (
      <FadeInWrapper>
        <div className="flex justify-center items-center bg-bodybg mt-[15rem] text-center p-6 rounded-lg shadow-xl">
          <p className="text-2xl font-extrabold text-defaulttextcolor drop-shadow-lg">
            üîç –ó–∞ –¥–∞ –º–æ–∂–µ—Ç–µ –¥–∞ —Ä–∞–∑–≥–ª–µ–¥–∞—Ç–µ –í–∞—à–∏—Ç–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª–Ω–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –º–æ–ª—è,
            –ø—ä—Ä–≤–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–π—Ç–µ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏. –¢–æ–≤–∞ —â–µ –Ω–∏ –ø–æ–∑–≤–æ–ª–∏ –¥–∞ —Å—ä–±–µ—Ä–µ–º
            –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏—Ç–µ –¥–∞–Ω–Ω–∏ –∏ –¥–∞ –í–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–º –ø–æ–¥—Ä–æ–±–µ–Ω –∞–Ω–∞–ª–∏–∑ üìä, —Å—ä–æ–±—Ä–∞–∑–µ–Ω
            —Å –í–∞—à–∏—Ç–µ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è. ‚öôÔ∏è
          </p>
        </div>
      </FadeInWrapper>
    );
  }

  return (
    <FadeInWrapper>
      {notification && (
        <Notification
          message={notification.message}
          type={notification.type}
          onClose={handleNotificationClose}
        />
      )}
      <Fragment>
        <div className="md:flex block items-center justify-between my-[1.5rem] page-header-breadcrumb">
          <div>
            <p className="font-semibold text-[1.125rem] text-defaulttextcolor dark:text-defaulttextcolor/70 !mb-0 "></p>
          </div>
        </div>
        <div className="grid grid-cols-12 gap-6">
          <div className="xl:col-span-12 col-span-12">
            <div
              className="accordion accordionicon-left accordions-items-separate"
              id="accordioniconLeft"
            >
              <div
                className="hs-accordion-group"
                data-hs-accordion-always-open=""
              >
                <div
                  className="hs-accordion accordion-item overflow-hidden active"
                  id="hs-basic-with-title-and-arrow-stretched-heading-one"
                >
                  <button
                    className="hs-accordion-toggle accordion-button hs-accordion-active:text-primary hs-accordion-active:pb-3 group py-0 inline-flex items-center justify-between gap-x-3 w-full font-semibold text-start text-gray-800 transition hover:text-secondary dark:hs-accordion-active:text-primary dark:text-gray-200 dark:hover:text-secondary"
                    aria-controls="hs-basic-with-title-and-arrow-stretched-collapse-one"
                    type="button"
                  >
                    –ú–æ–∏—Ç–µ –¢–æ–ø –ü—Ä–µ–ø–æ—Ä—ä–∫–∏ - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                    <svg
                      className="hs-accordion-active:hidden hs-accordion-active:text-primary hs-accordion-active:group-hover:text-primary block w-3 h-3 text-gray-600 group-hover:text-secondary dark:text-[#8c9097] dark:text-white/50"
                      width="16"
                      height="16"
                      viewBox="0 0 16 16"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M2 5L8.16086 10.6869C8.35239 10.8637 8.64761 10.8637 8.83914 10.6869L15 5"
                        stroke="currentColor"
                        strokeWidth="2"
                        strokeLinecap="round"
                      />
                    </svg>
                    <svg
                      className="hs-accordion-active:block hs-accordion-active:text-primary hs-accordion-active:group-hover:text-primary hidden w-3 h-3 text-gray-600 group-hover:text-secondary dark:text-[#8c9097] dark:text-white/50"
                      width="16"
                      height="16"
                      viewBox="0 0 16 16"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M2 11L8.16086 5.31305C8.35239 5.13625 8.64761 5.13625 8.83914 5.31305L15 11"
                        stroke="currentColor"
                        strokeWidth="2"
                        strokeLinecap="round"
                      />
                    </svg>
                  </button>
                  <div
                    id="hs-basic-with-title-and-arrow-stretched-collapse-one"
                    className="hs-accordion-content w-full overflow-hidden transition-[height] duration-300"
                    aria-labelledby="hs-basic-with-title-and-arrow-stretched-heading-one"
                  >
                    <div className="grid grid-cols-12 gap-x-6 mt-5 ml-5 mr-5">
                      <div className="xxl:col-span-6 col-span-12">
                        <MoviesAndSeriesRecommendationsTable
                          data={data.topRecommendations.recommendations}
                        />
                      </div>
                      <div className="xxl:col-span-6 col-span-12">
                        <ActorsDirectorsWritersRecommendationsTable
                          data={data}
                        />
                      </div>
                    </div>
                    <div className="grid grid-cols-12 gap-x-6 ml-5 mr-5">
                      <div className="xxl:col-span-6 col-span-12">
                        <GenresBarChart data={data} />
                      </div>
                      <div className="xxl:col-span-6 col-span-12">
                        <CountWidgets data={data} />
                      </div>
                    </div>
                  </div>
                </div>
                <div
                  className="hs-accordion accordion-item overflow-hidden"
                  id="hs-basic-with-title-and-arrow-stretched-heading-two"
                >
                  <button
                    className="hs-accordion-toggle accordion-button hs-accordion-active:text-primary hs-accordion-active:pb-3 group py-0 inline-flex items-center justify-between gap-x-3 w-full font-semibold text-start text-gray-800 transition hover:text-secondary dark:hs-accordion-active:text-primary dark:text-gray-200 dark:hover:text-secondary"
                    aria-controls="hs-basic-with-title-and-arrow-stretched-collapse-two"
                    type="button"
                  >
                    –ú–æ—è—Ç–∞ –ö–æ–ª–µ–∫—Ü–∏—è –∑–∞ –ì–ª–µ–¥–∞–Ω–µ - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                    <svg
                      className="hs-accordion-active:hidden hs-accordion-active:text-primary hs-accordion-active:group-hover:text-primary block w-3 h-3 text-gray-600 group-hover:text-secondary dark:text-[#8c9097] dark:text-white/50"
                      width="16"
                      height="16"
                      viewBox="0 0 16 16"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M2 5L8.16086 10.6869C8.35239 10.8637 8.64761 10.8637 8.83914 10.6869L15 5"
                        stroke="currentColor"
                        strokeWidth="2"
                        strokeLinecap="round"
                      />
                    </svg>
                    <svg
                      className="hs-accordion-active:block hs-accordion-active:text-primary hs-accordion-active:group-hover:text-primary hidden w-3 h-3 text-gray-600 group-hover:text-secondary dark:text-[#8c9097] dark:text-white/50"
                      width="16"
                      height="16"
                      viewBox="0 0 16 16"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        d="M2 11L8.16086 5.31305C8.35239 5.13625 8.64761 5.13625 8.83914 5.31305L15 11"
                        stroke="currentColor"
                        strokeWidth="2"
                        strokeLinecap="round"
                      />
                    </svg>
                  </button>
                  <div
                    id="hs-basic-with-title-and-arrow-stretched-collapse-two"
                    className="hs-accordion-content accordion-body hidden w-full overflow-hidden transition-[height] duration-300"
                    aria-labelledby="hs-basic-with-title-and-arrow-stretched-heading-two"
                  >
                    <div className="grid grid-cols-12 gap-x-6 mt-5 ml-5 mr-5">
                      <div className="xxl:col-span-6 col-span-12">
                        <MoviesAndSeriesRecommendationsTable
                          data={data.topRecommendations.recommendations}
                        />
                      </div>
                      <div className="xxl:col-span-6 col-span-12">
                        <ActorsDirectorsWritersRecommendationsTable
                          data={data}
                        />
                      </div>
                    </div>
                    <div className="grid grid-cols-12 gap-x-6 ml-5 mr-5">
                      <div className="xxl:col-span-6 col-span-12">
                        <GenresBarChart data={data} />
                      </div>
                      <div className="xxl:col-span-6 col-span-12">
                        <CountWidgets data={data} />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </Fragment>
    </FadeInWrapper>
  );
};

export default IndividualStats;
