import { FC, useEffect, useState, useCallback } from "react";
import AIAnalysisDashboard from "./Components/AIAnalysisDashboard";
import {
  F1ScoreData,
  PrecisionData,
  RecallData,
  RecommendationsAnalysis
} from "./aiAnalysator-types";
import RecommendationsAnalysesWidgets from "@/components/common/recommendationsAnalyses/recommendationsAnalyses";
import { Card } from "@/components/ui/card";
import FadeInWrapper from "@/components/common/loader/fadeinwrapper";
import {
  checkRelevanceForLastSavedRecommendations,
  getF1Score,
  getPrecisionTotal,
  getRecallTotal
} from "./helper_functions";
import { analyzeRecommendations } from "../helper_functions_common";
import ErrorCard from "@/components/common/error/error";
import {
  Accordion,
  AccordionItem,
  AccordionTrigger,
  AccordionContent
} from "@/components/ui/accordion";
import UserPreferences from "@/components/common/userPreferences/userPreferences";

const AIAnalysator: FC = () => {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [inTransition, setInTransition] = useState(false);
  const [direction, setDirection] = useState<"left" | "right">("right");
  const [precisionData, setPrecisionData] = useState<PrecisionData | null>(
    null
  );
  const [recallData, setRecallData] = useState<RecallData | null>(null);
  const [f1ScoreData, setF1ScoreData] = useState<F1ScoreData | null>(null);
  const [recommendationsAnalysis, setRecommendationsAnalysis] =
    useState<RecommendationsAnalysis>({
      relevantCount: 0,
      totalCount: 0,
      precisionValue: 0,
      precisionPercentage: 0,
      relevantRecommendations: []
    });
  const [showError, setShowError] = useState<boolean>(false);

  useEffect(() => {
    const fetchData = async () => {
      const token =
        localStorage.getItem("authToken") ||
        sessionStorage.getItem("authToken");
      if (!token) return;

      try {
        const lastSavedRecommendationsAndPreferences =
          await checkRelevanceForLastSavedRecommendations(token, setShowError);

        const {
          lastSavedRecommendations,
          relevanceResults,
          lastSavedUserPreferences
        } = lastSavedRecommendationsAndPreferences;

        if (
          lastSavedRecommendations.length > 0 &&
          relevanceResults.length > 0 &&
          lastSavedUserPreferences
        ) {
          const [precisionObject, recallObject] = await Promise.all([
            getPrecisionTotal(token, lastSavedUserPreferences),
            getRecallTotal(token, lastSavedUserPreferences)
          ]);

          const f1ScoreObject = await getF1Score(
            token,
            precisionObject.precision_exact,
            recallObject.recall_exact
          );

          setPrecisionData(precisionObject);
          setRecallData(recallObject);
          setF1ScoreData(f1ScoreObject);

          if (relevanceResults) {
            await analyzeRecommendations(
              lastSavedUserPreferences,
              lastSavedRecommendations,
              setRecommendationsAnalysis,
              false
            );
          }
        } else {
          setShowError(true);
        }
      } catch (error) {
        console.error("Error fetching AI analysis data:", error);
      }
    };

    fetchData();
  }, []);

  const handleNext = useCallback(() => {
    setDirection("right");
    setInTransition(true);

    setTimeout(() => {
      setCurrentIndex((prevIndex) =>
        recommendationsAnalysis?.relevantRecommendations.length
          ? (prevIndex + 1) %
            recommendationsAnalysis.relevantRecommendations.length
          : 0
      );
      setInTransition(false);
    }, 500);
  }, [recommendationsAnalysis]);

  const handlePrev = useCallback(() => {
    setDirection("left");
    setInTransition(true);

    setTimeout(() => {
      setCurrentIndex((prevIndex) =>
        recommendationsAnalysis?.relevantRecommendations.length
          ? (prevIndex -
              1 +
              recommendationsAnalysis.relevantRecommendations.length) %
            recommendationsAnalysis.relevantRecommendations.length
          : 0
      );
      setInTransition(false);
    }, 500);
  }, [recommendationsAnalysis]);

  // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ —Å–∞–º–æ —Å–ª–µ–¥ –∫–∞—Ç–æ –µ –¥–æ—à—ä–ª –æ—Ç–≥–æ–≤–æ—Ä—ä—Ç –æ—Ç –∑–∞—è–≤–∫–∏—Ç–µ
  const renderRecommendationsAnalysis =
    recommendationsAnalysis.relevantRecommendations.length > 0;

  const preferences = {
    id: 37,
    user_id: 1,
    preferred_genres_en: "Romance, Horror, Crime",
    preferred_genres_bg: "–†–æ–º–∞–Ω—Ç–∏—á–µ–Ω, –£–∂–∞—Å–∏, –ö—Ä–∏–º–∏–Ω–∞–ª–µ–Ω",
    mood: "",
    timeAvailability: "1 —á–∞—Å",
    preferred_age: "",
    preferred_type: "–§–∏–ª–º",
    preferred_actors: "–ù—è–º–∞–º –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è",
    preferred_directors: "–ù—è–º–∞–º –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è",
    preferred_countries: "–ù—è–º–∞–º –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è",
    preferred_pacing: "–±—ä—Ä–∑–∏ —Å –º–Ω–æ–≥–æ –Ω–∞–ø—Ä–µ–∂–µ–Ω–∏–µ",
    preferred_depth: "–°—Ä–µ–¥–Ω–∏ - —Å —è—Å–Ω–∏ —Å—é–∂–µ—Ç–Ω–∏ –ª–∏–Ω–∏–∏",
    preferred_target_group: "–¢–∏–π–Ω–µ–π–¥–∂—ä—Ä–∏",
    interests: null,
    date: "2024-10-31 08:21:09"
  };
  return (
    <FadeInWrapper>
      {!showError ? (
        <div className="p-[1.5rem]">
          <div className="z-10 max-w-6xl w-full mx-auto font-mono text-sm">
            <UserPreferences preferences={preferences} />
            <div className="text-center !text-lg box p-6 flex flex-col gap-6 !rounded-xl justify-center items-center">
              <Card className="bg-white dark:bg-bodybg2/50 dark:border-black/10 dark:text-defaulttextcolor/70 font-semibold text-xl p-4 rounded-md shadow-lg dark:shadow-xl text-center leading-relaxed mx-auto">
                <h2 className="text-4xl opsilion text-defaulttextcolor dark:text-white/80">
                  –ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –∑–Ω–∞–µ—Ç–µ –∫–æ–ª–∫–æ –¥–æ–±—Ä–µ —Å–µ –µ —Å–ø—Ä–∞–≤–∏–ª AI-—ä—Ç —Å
                  –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ—Ç–æ –Ω–∞ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏ —Å–ø–µ—Ü–∏–∞–ª–Ω–æ –∑–∞ –í–∞—Å?
                </h2>
              </Card>
              <Card className="bg-white dark:bg-bodybg2/50 dark:border-black/10 dark:text-defaulttextcolor/70 font-semibold text-xl p-4 w-full rounded-md shadow-lg dark:shadow-xl text-center leading-relaxed mx-auto">
                <h2 className="text-xl text-defaulttextcolor dark:text-white/80">
                  –ó–∞ —Ü–µ–ª—Ç–∞ –µ –ø—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–æ –ø—ä—Ä–≤–æ –¥–∞ —Å–µ –∑–∞–ø–æ–∑–Ω–∞–µ—Ç–µ —Å—ä—Å —Å–ª–µ–¥–Ω–∏—Ç–µ
                  –ø–æ–Ω—è—Ç–∏—è:
                </h2>
              </Card>
              <div className="text-sm w-full">
                <Accordion type="single" collapsible className="space-y-4">
                  {/* Relevance */}
                  <AccordionItem value="relevance">
                    <AccordionTrigger className="opsilion">
                      üéØ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç
                    </AccordionTrigger>
                    <AccordionContent>
                      –°–≤–æ–π—Å—Ç–≤–æ, –∫–æ–µ—Ç–æ –¥–∞–¥–µ–Ω–∞ –ø—Ä–µ–ø–æ—Ä—ä–∫–∞ –º–æ–∂–µ –¥–∞ –ø—Ä–∏—Ç–µ–∂–∞–≤–∞. –î–∞–ª–∏
                      –¥–∞–¥–µ–Ω —Ñ–∏–ª–º –∏–ª–∏ —Å–µ—Ä–∏–∞–ª –µ{" "}
                      <span className="font-semibold">—Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω </span> —Å–µ
                      –æ–ø—Ä–µ–¥–µ–ª—è —Å–ø—Ä—è–º–æ —Ç–æ–≤–∞ –¥–∞–ª–∏ –Ω–µ–≥–æ–≤–∏—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫–∞—Ç–æ{" "}
                      <span className="font-semibold">
                        –∂–∞–Ω—Ä, –µ–º–æ—Ü–∏–æ–Ω–∞–ª–Ω–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ, —Ä–∞–∑–ø–æ–ª–∞–≥–∞–µ–º–æ –≤—Ä–µ–º–µ –∑–∞
                        –≥–ª–µ–¥–∞–Ω–µ
                      </span>{" "}
                      –∏ –¥—Ä—É–≥–∏ —Å–µ —Å—ä–æ–±—Ä–∞–∑—è–≤–∞—Ç —Å{" "}
                      <span className="font-semibold">–í–ê–®–ò–¢–ï </span>{" "}
                      –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è. –í—Å–∏—á–∫–æ —Ç–æ–≤–∞ —Å–µ
                      —Å–ª—É—á–≤–∞ —Å –ø–æ–º–æ—â—Ç–∞ –Ω–∞{" "}
                      <span className="font-semibold">
                        –ê–ª–≥–æ—Ä–∏—Ç—ä–º–∞ –∑–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç
                      </span>
                      , –æ–ø–∏—Å–∞–Ω –ø–æ-–Ω–∞–¥–æ–ª—É –≤ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.
                    </AccordionContent>
                  </AccordionItem>

                  {/* Precision */}
                  <AccordionItem value="precision">
                    <AccordionTrigger className="opsilion">
                      ‚úÖ Precision
                    </AccordionTrigger>
                    <AccordionContent>
                      <p>
                        –ò–∑–º–µ—Ä–≤–∞ –∫–∞–∫–≤–∞ —á–∞—Å—Ç –æ—Ç –ø—Ä–µ–ø–æ—Ä—ä–∫–∏—Ç–µ, –∫–æ–∏—Ç–æ —Å—Ç–µ –Ω–∞–ø—Ä–∞–≤–∏–ª–∏,
                        —Å–∞ <span className="font-semibold">–Ω–∞–∏—Å—Ç–∏–Ω–∞ </span>{" "}
                        —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏. –í–∏—Å–æ–∫–∞—Ç–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞{" "}
                        <span className="font-semibold">Precision</span>{" "}
                        –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ –∫–æ–≥–∞—Ç–æ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –ø—Ä–µ–ø–æ—Ä—ä—á–≤–∞ –Ω–µ—â–æ, —Ç–æ
                        –≤–µ—Ä–æ—è—Ç–Ω–æ —â–µ –±—ä–¥–µ –ø–æ–¥—Ö–æ–¥—è—â–æ –∑–∞ –≤–∞—Å.
                      </p>
                      <Card className="bg-white dark:bg-bodybg2 dark:border-black/10 dark:text-defaulttextcolor/70 font-semibold text-xl p-4 rounded-md shadow-lg dark:shadow-xl text-center leading-relaxed mx-auto mt-5">
                        <div className="flex items-center space-x-2 justify-center items-center">
                          <span className="font-semibold">Precision =</span>
                          <div className="text-center">
                            <p className="text-primary text-sm">
                              –≤—Å–∏—á–∫–∏ –†–ï–õ–ï–í–ê–ù–¢–ù–ò –ø—Ä–µ–ø–æ—Ä—ä–∫–∏ –ø—Ä–∞–≤–µ–Ω–∏ –Ω—è–∫–æ–≥–∞ –ù–ê –í–ê–°
                            </p>
                            <div className="border-b border-gray-400 dark:border-gray-600 my-2"></div>
                            <p className="text-secondary text-sm">
                              –≤—Å–∏—á–∫–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏, –∫–æ–∏—Ç–æ –Ω—è–∫–æ–≥–∞ —Å–∞ –ø—Ä–∞–≤–µ–Ω–∏ –ù–ê –í–ê–°
                            </p>
                          </div>
                        </div>
                      </Card>
                    </AccordionContent>
                  </AccordionItem>

                  {/* Recall */}
                  <AccordionItem value="recall">
                    <AccordionTrigger className="opsilion">
                      üîç Recall
                    </AccordionTrigger>
                    <AccordionContent>
                      <p>
                        –ò–∑–º–µ—Ä–≤–∞ –∫–∞–∫–≤–∞ —á–∞—Å—Ç –æ—Ç –≤—Å–∏—á–∫–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏, –∫–æ–∏—Ç–æ —Å–∞
                        –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏ –∫–∞—Ç–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏, —Å–∞ –±–∏–ª–∏ –ø—Ä–µ–ø–æ—Ä—ä—á–∞–Ω–∏ –Ω–∞{" "}
                        <span className="font-semibold">–í–ê–°</span>. –í–∏—Å–æ–∫–∞—Ç–∞
                        —Å—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞ Recall –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ —Å–∏—Å—Ç–µ–º–∞—Ç–∞{" "}
                        <span className="font-semibold">–ù–ï </span> –ø—Ä–æ–ø—É—Å–∫–∞{" "}
                        <span className="font-semibold">
                          –≤–∞–∂–Ω–∏ (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏){" "}
                        </span>{" "}
                        –ø—Ä–µ–ø–æ—Ä—ä–∫–∏, –¥–æ—Ä–∏ –∞–∫–æ –≤–∫–ª—é—á–≤–∞ –Ω—è–∫–æ–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏.
                      </p>
                      <Card className="bg-white dark:bg-bodybg2 dark:border-black/10 dark:text-defaulttextcolor/70 font-semibold text-xl p-4 rounded-md shadow-lg dark:shadow-xl text-center leading-relaxed mx-auto mt-5">
                        <div className="flex items-center space-x-2 justify-center items-center">
                          <span className="font-semibold">Recall =</span>
                          <div className="text-center">
                            <p className="text-primary text-sm">
                              –≤—Å–∏—á–∫–∏ –†–ï–õ–ï–í–ê–ù–¢–ù–ò –ø—Ä–µ–ø–æ—Ä—ä–∫–∏ –ø—Ä–∞–≤–µ–Ω–∏ –Ω—è–∫–æ–≥–∞ –ù–ê –í–ê–°
                            </p>
                            <div className="border-b border-gray-400 dark:border-gray-600 my-2"></div>
                            <p className="text-secondary text-sm">
                              –≤—Å–∏—á–∫–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏, –∫–æ–∏—Ç–æ —Å–∞ –†–ï–õ–ï–í–ê–ù–¢–ù–ò –Ω–∞ –í–ê–®–ò–¢–ï
                              –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–Ω–∏—è, –∏–∑–º–µ–∂–¥—É —Ç–µ–∑–∏ –≤ —Ü—è–ª–∞—Ç–∞ —Å–∏—Å—Ç–µ–º–∞
                            </p>
                          </div>
                        </div>
                      </Card>
                    </AccordionContent>
                  </AccordionItem>

                  {/* F1 Score */}
                  <AccordionItem value="f1-score">
                    <AccordionTrigger className="opsilion">
                      ‚öñÔ∏è F1 Score
                    </AccordionTrigger>
                    <AccordionContent>
                      <p>
                        <span className="font-semibold">
                          –ë–∞–ª–∞–Ω—Å–∏—Ä–∞–Ω –ø–æ–∫–∞–∑–∞—Ç–µ–ª
                        </span>
                        , –∫–æ–π—Ç–æ –∫–æ–º–±–∏–Ω–∏—Ä–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏—Ç–µ –Ω–∞{" "}
                        <span className="font-semibold">Precision</span> –∏{" "}
                        <span className="font-semibold">Recall</span>,
                        –ø–æ–∫–∞–∑–≤–∞–π–∫–∏ –∫–æ–ª–∫–æ –¥–æ–±—Ä–µ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –Ω–∞–º–∏—Ä–∞ —Ç–æ—á–Ω–∏—è –±–∞–ª–∞–Ω—Å
                        –º–µ–∂–¥—É —Ç—è—Ö. –í–∏—Å–æ–∫–∏—è—Ç{" "}
                        <span className="font-semibold">F1 Score</span>{" "}
                        –æ–∑–Ω–∞—á–∞–≤–∞, —á–µ —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –∏–º–∞ –¥–æ–±—Ä–æ –ø—Ä–µ–¥—Å—Ç–∞–≤—è–Ω–µ –∫–∞–∫—Ç–æ –ø–æ
                        –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –Ω–∞{" "}
                        <span className="font-semibold">
                          —Ç–æ—á–Ω–æ—Å—Ç—Ç–∞ –Ω–∞ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏—Ç–µ
                        </span>
                        , —Ç–∞–∫–∞ –∏ –Ω–∞
                        <span className="font-semibold">
                          –ø–æ–∫—Ä–∏—Ç–∏–µ—Ç–æ —Å–ø—Ä—è–º–æ –≤—Å–∏—á–∫–∏ –≤—ä–∑–º–æ–∂–Ω–æ—Å—Ç–∏
                        </span>
                        .
                      </p>
                      <Card className="bg-white dark:bg-bodybg2 dark:border-black/10 dark:text-defaulttextcolor/70 font-semibold text-xl p-4 rounded-md shadow-lg dark:shadow-xl text-center leading-relaxed mx-auto mt-5">
                        <div className="flex items-center space-x-2 justify-center items-center">
                          <span className="font-semibold">F1 Score =</span>
                          <div className="text-center">
                            <p className="text-primary text-sm">
                              2 x Precision x Recall
                            </p>
                            <div className="border-b border-gray-400 dark:border-gray-600 my-2"></div>
                            <p className="text-secondary text-sm">
                              Precision + Recall
                            </p>
                          </div>
                        </div>
                      </Card>
                    </AccordionContent>
                  </AccordionItem>
                </Accordion>
              </div>
            </div>

            {precisionData && recallData && f1ScoreData && (
              <AIAnalysisDashboard
                precisionData={precisionData}
                recallData={recallData}
                f1ScoreData={f1ScoreData}
              />
            )}
            {renderRecommendationsAnalysis && (
              <RecommendationsAnalysesWidgets
                recommendationsAnalysis={recommendationsAnalysis}
                currentIndex={currentIndex}
                handlePrev={handlePrev}
                handleNext={handleNext}
                inTransition={inTransition}
                setInTransition={setInTransition}
                direction={direction}
              />
            )}
          </div>
        </div>
      ) : (
        <ErrorCard
          message="üîç –ó–∞ –¥–∞ –º–æ–∂–µ—Ç–µ –¥–∞ —Ä–∞–∑–≥–ª–µ–¥–∞—Ç–µ –∫–æ–ª–∫–æ –¥–æ–±—Ä–µ —Å–µ –µ —Å–ø—Ä–∞–≤–∏–ª AI-—ä—Ç —Å
                –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ—Ç–æ –Ω–∞ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏ –∑–∞ –≤–∞—Å, –º–æ–ª—è, –ø—ä—Ä–≤–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞–π—Ç–µ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏ –∑–∞ —Ñ–∏–ª–º–∏ –∏ —Å–µ—Ä–∏–∞–ª–∏."
          redirectUrl={`${
            import.meta.env.BASE_URL
          }app/recommendations/movies_series`}
          redirectText="–ö—ä–º –Ω–æ–≤–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∏"
        />
      )}
    </FadeInWrapper>
  );
};

export default AIAnalysator;
